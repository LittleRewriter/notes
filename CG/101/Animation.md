# Animation / Simulation

## Animation Sketch

Animation是一种交流的工具，展示动起来的东西，所以更关注好不好看。传统的动画是手绘为主，所以不是很在意其正确性。

如今，动画更类似于对几何的拓展。在算出来之后，把3D模型延伸到时间上，就是顺序。

动画本质是在某段固定时间上播放图片，比如电影就是24 fps，平常的视频为30fps，而VR需要90fps.

3200BC，人类发现在墙上已经有了壁画，这些壁画能连成很好的动画。1831年，出现了可以旋转的圆盘，在某种频率转动圆盘的时候会出现动画。1878年，人类开始发明电影技术来科研，形成了运动的马。

1937年，Disney的*Snow White and the Seven Dwarfs*是第一部手绘的完整时长动画。1963年，Sketchpad可以用Light pen做出简单的数字动画。1972年，Ed Catmull做出了Computer Animated faces，可以显示任务级别。1993年，*Jurassic Park*轰动性的把电脑生产的恐龙加入到了电影中，具有里程碑意义。1995年Pixar的*Toy Story*是第一个由Computer Generated的完整长度电影，主要技术是光栅化。现在动画电影中的技术越来越发达，动画往往不需要特别真实的物理效果，但是其技术已经不可同日而语。

Keyframe Animation是最为古老的动画，重要位置是关键帧。最早期的时候，关键帧由主美绘制，助手进行插帧，工作量很大。flash可以自动生成补帧，自动算出中间帧，减轻了很大的工作量。

帧与帧之间，常常使用的是Keyframe Interpolation。插值的关键在于如何良好的插值，比起传统的线性插值，人们更倾向于具有C1连续的Spline。所以动画与几何之间关联很多。

## Physical simulation

现在很多时候使用的是物理模拟。

比如，牛顿定律
$$
F = ma
$$
可以计算出来下一个时刻的物理公式。再比如，对于抛物线
$$
x_{t+dt} = x_t + v_t dt + \frac{1}{2}a_t (dt)^2
$$
这完全可以推广到衣物上。只要我们能把受力分析清楚，这种布料模拟就是完全可能的。

流体是仿真领域一个很重要的话题，流体的渲染和运动是两个很大的话题。只有正确建立这种相互作用，才能模拟出来效果。

## Mass Spring System

Mass Spring System，质点弹簧系统，是最常见的物理系统。对弹簧来说，受到的力
$$
\vec f_{a\to b} = k_s(\vec b - \vec a), \vec f_{b \to a} = -\vec f_{a \to b}
$$
这就是Hooke's Law。但是弹簧一般都有原长，所以
$$
\vec f_{a\to b} = k_s (\vec b-\vec a)^0 (||b-a||-l)
$$
这样系统会永远处于振动状态，所以引入摩擦力damping
$$
\pmb f = -k_d \dot{\pmb b}
$$
这个摩擦力只能描述外部力，不适用于内部摩擦力。所以我们将其进一步完善
$$
\pmb{f_b} = -k_d (\pmb{b} - \pmb{a})^0 (\pmb{\dot b} - \pmb {\dot a}) (\pmb{b} - \pmb{a})^0
$$
其中，$(\pmb{b} - \pmb{a})^0 (\pmb{\dot b} - \pmb {\dot a})$相当于相对速度在相对方向上的投影大小，是一个数量。这样可以保证其圆周运动不受影响。最后将两种力统合起来，就是弹簧所受的力。

弹簧不同组合可以组合成不同形状。比如，纸可以是平面上弹簧连起来，三维空间也可以连接成立方体。

现在考虑布料模拟，假如我们把布料看成弹簧点阵，那么

- 切变会影响形状
- out-of-plane bending，即在不同平面上的弯曲

如果在点阵中间加上斜着的质点弹簧系统，就会抵抗这些切边，也就是在主对角线和副对角线都可以抵抗切变力了。接下来，再引入一种“skip-connection”，让一个点和隔一个点进行连接，这样再弯曲平面，也会引起长度变化了。当然这种连接是比较弱的，只能起到辅助作用。

## Particle System

粒子系统是很多小的粒子，其建模方法就是对小粒子进行建模，然后定义其受到的力。比如，粒子受到的风力、相互之间的碰撞、引力等，然后相互之间进行模拟，得到各式各样的效果。对于系统来说有很多挑战。

这里有一个非常简洁的效果：

- 生成粒子
- 计算粒子间作用力
- 更新粒子位置
- 删除死去的粒子
- 渲染粒子

这个过程中，难点就是计算粒子间的作用力，也可以用粒子来模拟这种流体。

从粒子系统向前延申，粒子就是群体中的个体。这些个体间存在斥力、引力等，可以模拟出比较复杂的种群。

## Kinematics， Rigging and Motion capture

正向的运动学比较简单。我们需要描述一个骨骼系统，表征一个拓扑结构，定义不同关节，这种关节有Pin、Ball和Prismatic joint等。

假如一个关节，第一段旋转$\theta_1$，第二段旋转$\theta_2$，那么尖端的位置是很容易计算出来的。只要定义位置和连接方式，那么每个点的位置就随之确定。

这种方法很容易实现，但不够直观。Inverse Kinematics就是完成这一工作的：让尖端位置进行移动，然后反过来求解不同关节的位置。这个求解相对而言就比较复杂；同时，这种解往往是有很多的，也有可能存在无解情况。对此，人们往往采用一些优化方法来完成。Rigging就是对形状的控制，是一种“木偶”，可以形成某种造型。动画界常常通过Rigging来添加各种动作，这个绑骨是比较复杂的。

我们可以简单的认为，给角色一些控制点，让角色能“拉着”。可以通过插值的方式。

Motion Capture也是常见的技术手段。对于真人而言，在人做动作的时候拍下来，反映到虚拟的人物上，就能省很多事情。动作捕捉真实感非常强，同时可以获得大量数据。但是设置场景等准备比较复杂，同时捕捉出来动作的合理性也有所欠缺，和预期的动画目标也是有所区别的。如今常使用贴片等，来实现对某些位置的准确测量。

测出来的结果是一个控制点在不同时间上的变化，得到一系列的数据。《阿凡达》就使用了面部的动作捕捉，有很好的效果。

## Production Line

对于整个电影来说，有这些过程

- Pre production
  - 想法
  - 剧情
  - 原画
  - 播放原画
  - 设计
- Production
  - 布局，Layout
  - R&D
  - 建模
  - Texturing
  - Rigging
  - Animation
  - Visual Effects(VFX)，Lighting，Rendering
- Post Production
  - Composing
  - 2D VFX
  - Color correction
  - Output

构成了一个现代化的流水线。