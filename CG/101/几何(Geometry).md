# 几何(Geometry)

## Introduction to geometry

在世界上存在一些光滑曲面，而我们的描述很多时候是离散的。

如何恰当的描述这些线面？

在图形学中，一般将几何分成两类：

- 隐式几何（implicit geometry）
- 显示几何（explicit geometry）

隐式几何基于传统顶点。一般的，我们用$f(x,y,z)=0$描述一个曲面。它的形式很简洁，但是不直观，同时采样也比较困难。而优点在于，很容易判断点面关系。

显示则是做一个从$\mathbb{R}^2 \rightarrow \mathbb{R}^3$的映射$(u,v) \rightarrow (x,y,z)$。例如，参数方程$f(u,v)=((2+\cos u)\cos v,(2+\cos u)\sin v,\sin u)$可以表示一个圆环，这种表示在判断内外关系上会比较难。

常见的隐式几何：

Constructive Solid Geometry(构造实体集合，CSG)是对一部分几何做布尔运算。例如给出两个几何体，求$A\cup B, A \cap B$等。将这些组合起来，我们可以做出诸如$(X \cap Y)\backslash (U \cup V \cup W)$。

Distance Functions描述距离函数。例如根据到两个球的最小距离，可以模拟两个球从远到近融合的过程。

在距离函数不容易表示的时候，可以用Level Set，也就是离散化的函数值。找到值为0的点进行提取，就得到了新的形式。某种意义上，它就是等高线。

分形是特殊的几何描述方法。自相似的形体就是分形的形体，图形学上可能会引起很多复杂情况。

常见的显式几何：

Point Cloud 点云。这是最简单的表示方法，定义$S=\{(x,y,z)\mid (x,y,z) \in V\}$，用大量点来描述几何。一般来说，做三维扫描，得到的就是点云。点云需要转化为多边形面。

Polygon mesh多边形面，尤其是三角形面和四边形面。这是图形学中最广泛应用的显式表示。一种常见的`obj`文件，分开记录了点坐标、发现坐标、纹理坐标和他们的关系。

## Curves

Bezier Curves是用一系列控制点来控制一条曲线。

假设平面上有四个点$p_0,p_1,p_2,p_3$，我们目标得到一条经过$p_0,p_3$且切线方向沿$p_1-p_0,p_3-p_2$的唯一曲线。

求解的算法是de Casteljau算法。

三个点确定一条二次贝塞尔曲线。de Caseljau试图找这样一些在曲线上的点。分别取$b_0 b_1$的$b_0^1=(1-t)b_0+tb_1$，$b_1^1 = (1-t)b_1+tb_2$，那么$b_0^2=(1-t)b_0^1+tb_1^1$。也就是
$$
b_i^k = (1-t)b_i^{k-1}+tb_{i+1}^{k-1}
$$
通过连续的$t$取值，得到了一条连续的曲线，就是Bezier曲线。

将上面的式子展开，
$$
b_0^2 = (1-t)^2 b_0 + 2t(1-t)b_1+t^2 b_2
$$
....迭代会发现
$$
b^n(t) = \sum^n_{j=0} b_j B_j^n(t)
$$
其中$B_j^n(t)$是$t,1+t$的二项式系数
$$
B_j^n(t) = \binom{n}{i}t^i(1-t)^{n-i}
$$
称为Bernstein Polynomial

在特点上，
$$
b(0) = b_0, b(1) = b_n
$$

$$
b'(0) = k(b_1-b_0),b'(1)=k(b_n-b_{n-1})
$$

而最优雅的是，Bezier曲线在仿射变换后等价于控制点仿射变换后重新绘制的结果。

同时，Bezier曲线位于控制点形成的 凸包内。

如果点很多，我们画出来的贝塞尔曲线会非常平滑，而不利于用中间点控制。一般，我们取四个点为一个单位，控制Bezier曲线，得到的就是目标曲线。这样分段得到的就是Piecewise Bezier Curve。

如果第一段曲线的最后两个控制点和下一段曲线的前两个控制点共线，那么在切线方向上也是连续的，此时就成了光滑的曲线。如果$a_n=b_0$，就叫这种连续为$C^0$连续。当$a_n=b_0=\frac{1}{2}(a_{n-1}+b_1)$，就叫这种连续是$C^1$连续。

Spline（样条）是一个特定阶导数连续的曲线。常见的样条是B-splines（Basis splines，基函数样条），Bernstein函数的样条。

这些内容比较复杂，不再展开。

## Surface

Bezier Surface（贝塞尔曲面）是对贝塞尔曲线的进一步延拓。

假设有一个$4\times 4$的网格，我们对其中的每一列做贝塞尔曲线，然后在曲线上取点再做贝塞尔曲线，这个曲线扫过的面就是贝塞尔曲面。

形式化的，定义
$$
P(u,v) = \sum_{i=0}^n \sum_{j=0}^m B_{i,m}(u) B_{j,n}(v) P_{ij}, u,v \in [0,1]
$$
其中$B_{i,m}(u) = \binom{m}{i}u^i(1-u)^{m-i}$是Bernstein多项式。在$P_{00}P_{10}P_{10}$，$P_{0n}P_{1n}P_{0n-1}$，$P_{mn}P_{mn-1}P_{m-1n}$，$P_{m0}P_{m-10}P_{m1}$构成了四个角处的切平面。同样，它满足凸包性。

同样的，对Bezier曲面也可以定义$C^0$连续和$C^1$连续。

有时，我们使用三角域上的贝塞尔曲面。定义二元基函数
$$
B_{i,j,k}(u,v,w) = \frac{n!}{i!j!k!}u^i v^j w^k
$$
其中$i+j+k=1$。这实际上对应了$(u+v+w)^n$的$n$次展开。那么，三角域Bezier曲面就是
$$
P(u,v,w) = \sum_{i+j+k=n} P_{i,j,k} B^n_{i,j,k}(u,v,w)
$$
也可以用类似的de Casteljau算法进行求解。

## Mesh

在图形上，更常见的是采用网格。对于网格，我们需要常见操作：

- subdivision 细分
- simplification 简化
- regularization 正规化

曲面细分是一个非常重要的操作。核心是两步操作：做出更多三角形，将三角形位置归正。

Loop Subdivision是很常见的做法。主要方法如下：

- 将每个三角形分成四个新的三角形
- 对于新产生的顶点和旧的顶点，分开调整位置

假设两个三角形$\triangle ABD, \triangle ABC$，$AB$中点是一个新顶点$P$，那么
$$
P = \frac{3}{8}(A+B) + \frac{1}{8}(C+D)
$$
对于旧顶点，它一定是$n$个三角形的交点。换言之，是该顶点的度。接下来定义
$$
u = \cases{3/16 & n=3\\3/(8n) & otherwise}
$$
那么
$$
P = (1-nu) P_0 + u \sum^n_{i=1} A_i
$$
其中$A_i$为相邻顶点的坐标。这个算法本质还是进行一个加权平均。

另一种算法是Catmull-Clark Subdivision。这个算法可针对一般网格。

定义

- non-quad face：非四边形面的点
- extraordinary vertex：奇异点，度不为4的点

取面的中点和边的中点进行连接，得到的就是新的网格。与非三角形面形成的点，一定是奇异点。但是同时，非四边形面都消失的。换言之，**非四边形面在一次细分之后，转化为了一个奇异点**。在第一次细分之后，不会有新的非四边形面，也不会有新的非奇异点。

它的核心是将点区分为三类。

（1）面的中心点
$$
f = \frac{v_1+v_2+v_3+v_3}{4}
$$
（2）边的中心点
$$
e = \frac{v_1+v_2+f_1+f_2}{4}
$$
其中$v_1,v_2$为端点，$f_1,f_2$为相邻面中心点

（3）面的公共节点
$$
v = \frac{1}{4}p + \frac{1}{8}(m_1+m_2+m_3+m_4) + \frac{1}{16} (f_1+f_2+f_3+f_4)
$$
其中$f$为相邻面的中心点，$m$为相邻边的中心点，$p$为自身的原坐标。

有的时候为了效率考虑，有的时候距离较远，所以我们可能需要简化这种三角形。

一种常见的方法是Edge Collapse(边坍缩)。先引入Quadric Error Metrics(二次误差度量)。

假如在某个位置上，使得
$$
S = \sum_1^n d_i^2
$$
其中$d_i$为某个边到关联面$i$的距离。依次坍缩二次度量误差最小的边！

但是坍缩某条边，其他边的二次度量误差也会发生变化。所以这里可以用一个堆来维护坍缩过程。

这一算法本质是贪心的，但是结果很好。

## Shadows

为了凑点内容，把Shadows放这好了。

这是Ray-tracing的前置之一。

Shadow Mapping是一个图像空间的做法。它的思想是，如果某些点不在阴影里，说明可以从摄像机看到这个点，也可以从光源看到这个点。利用这种现象，就可以看到阴影。

Shadow Mapping的前提是点光源，这种阴影一般有明显的阴影边界。这种阴影叫做“硬阴影”，每个点只有属于阴影和不属于阴影两种状态。

从光源看向场景，生成一幅图，标记看到点的对应深度。接下来从摄像机出发，看向场景，将某个点投影回相机的成像平面上。现在去和之前记录的深度比较，如果这个深度更深，说明被挡住了。此时则视为阴影。

在这里经常会引入浮点误差，所以有时需要加一些浮点误差图。同时，shadow map的分辨率也需要进行平衡，容易导致效果不好。

时至今日，Shadow mapping仍然是处理阴影的主流技术。

当然，有很多方法优化可以让这种阴影变化为软阴影，但是本质这个方法做出还是硬阴影。

软阴影是一种自然现象，在物理上，阴影分成本影(umbra)和半影(penumbra)两部分。想要做出漂亮的阴影，就是光线追踪的基础。